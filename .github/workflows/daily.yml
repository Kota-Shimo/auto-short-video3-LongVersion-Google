name: Auto-Vocab-Daily

on:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œï¼ˆUTCè¡¨è¨˜ï¼‰â€»JSTã«ç›´ã™ã¨å³ã‚³ãƒ¡ãƒ³ãƒˆã®æ™‚åˆ»
  # â‘  å˜èªï¼‹ä¾‹æ–‡ã®ã¿ï¼ˆä¼šè©±ãªã—ï¼‰    â†’ JST 09:00
  - schedule:
      - cron: '0 0 * * *'      # 09:00 JST
  # â‘¡ æœ€å¾Œã«ä¼šè©±1ãƒ–ãƒ­ãƒƒã‚¯ã®ã¿        â†’ JST 15:00
  - schedule:
      - cron: '0 6 * * *'      # 15:00 JST
  # â‘¢ å„ãƒ©ã‚¦ãƒ³ãƒ‰ã”ã¨ã«ä¼šè©±ã‚ã‚Š       â†’ JST 21:00
  - schedule:
      - cron: '0 12 * * *'     # 21:00 JST

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # æ‰‹å‹•å®Ÿè¡Œï¼šã©ã®ã‚¿ã‚¤ãƒ—ã‚’å‹•ã‹ã™ã‹é¸æŠå¯
  workflow_dispatch:
    inputs:
      mode:
        description: "å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠ"
        required: true
        default: "final-convo"  # â† æ‰‹å‹•ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯â‘¡ï¼ˆæœ€å¾Œã«ä¼šè©±1ãƒ–ãƒ­ãƒƒã‚¯ï¼‰
        type: choice
        options:
          - no-convo       # â‘  å˜èªï¼‹ä¾‹æ–‡ã®ã¿ï¼ˆä¼šè©±ãªã—ï¼‰
          - final-convo    # â‘¡ å˜èªï¼‹ä¾‹æ–‡ï¼‹æœ€å¾Œã«ä¼šè©±1ãƒ–ãƒ­ãƒƒã‚¯
          - every-convo    # â‘¢ å˜èªï¼‹ä¾‹æ–‡ï¼‹å„ãƒ©ã‚¦ãƒ³ãƒ‰ã”ã¨ã«ä¼šè©±

concurrency:
  group: auto-vocab-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # å…±é€šã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ã¾ã¨ã‚ãŸã‚¸ãƒ§ãƒ–ï¼ˆä»¥é™ã®ã‚¸ãƒ§ãƒ–ãŒç¶™æ‰¿ã—ã¦ä½¿ã†ï¼‰
  _setup:
    name: Prepare environment (shared)
    runs-on: ubuntu-latest
    outputs:
      dummy: ok
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: ğŸ“¦ Install requirements (FFmpegå«ã‚€)
        run: |
          set -euxo pipefail
          sudo apt-get update -y
          sudo apt-get install -y ffmpeg
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: ğŸ”‘ Restore YouTube tokens (acc1â€“acc9; ç„¡ã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—)
        env:
          YT_ACC1: ${{ secrets.YT_TOKEN_ACC1 }}
          YT_ACC2: ${{ secrets.YT_TOKEN_ACC2 }}
          YT_ACC3: ${{ secrets.YT_TOKEN_ACC3 }}
          YT_ACC4: ${{ secrets.YT_TOKEN_ACC4 }}
          YT_ACC5: ${{ secrets.YT_TOKEN_ACC5 }}
          YT_ACC6: ${{ secrets.YT_TOKEN_ACC6 }}
          YT_ACC7: ${{ secrets.YT_TOKEN_ACC7 }}
          YT_ACC8: ${{ secrets.YT_TOKEN_ACC8 }}
          YT_ACC9: ${{ secrets.YT_TOKEN_ACC9 }}
        run: |
          set -euo pipefail
          mkdir -p tokens
          restore_token() {
            local NAME="$1" ; local VAL="$2"
            if [ -n "${VAL:-}" ]; then
              echo "Restoring $NAME ..."
              echo "$VAL" | base64 -d > "tokens/token_${NAME}.pkl"
            else
              echo "Skip $NAME (secret not set)"
            fi
          }
          restore_token acc1 "$YT_ACC1"
          restore_token acc2 "$YT_ACC2"
          restore_token acc3 "$YT_ACC3"
          restore_token acc4 "$YT_ACC4"
          restore_token acc5 "$YT_ACC5"
          restore_token acc6 "$YT_ACC6"
          restore_token acc7 "$YT_ACC7"
          restore_token acc8 "$YT_ACC8"
          restore_token acc9 "$YT_ACC9"

  # â‘  å˜èªï¼‹ä¾‹æ–‡ã®ã¿ï¼ˆä¼šè©±ãªã—ï¼‰ â€” NO_CONVO=1, FINAL_CONVO=0
  vocab_no_convo:
    name: â‘  Vocab Onlyï¼ˆå˜èªï¼‹ä¾‹æ–‡ã®ã¿ï¼ä¼šè©±ãªã—ï¼‰
    runs-on: ubuntu-latest
    needs: _setup
    # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« 0 0 * * * ã«åå¿œ or æ‰‹å‹•ã§ mode=no-convo ã‚’é¸ã‚“ã æ™‚ã ã‘å®Ÿè¡Œ
    if: >
      (github.event_name == 'schedule' && github.event.schedule == '0 0 * * *')
      || (github.event_name == 'workflow_dispatch' && inputs.mode == 'no-convo')
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ¬ Generate & Upload
        env:
          OPENAI_API_KEY:      ${{ secrets.OPENAI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          # â”€ å‹•ç”»ã®ä¸­èº«ã‚’æ±ºã‚ã‚‹ãƒ•ãƒ©ã‚° â”€
          NO_CONVO:     "1"    # ä¼šè©±ã‚’å®Œå…¨ã«å‡ºã•ãªã„
          FINAL_CONVO:  "0"    # æœ€å¾Œã®ä¼šè©±ãƒ–ãƒ­ãƒƒã‚¯ã‚‚ç„¡ã—
          CONVO_LINES:  "0"    # ä½¿ã‚ã‚Œãªã„ãŒæ˜ç¤ºçš„ã«0
          VOCAB_WORDS:  "12"   # 1ãƒ©ã‚¦ãƒ³ãƒ‰ã®å˜èªæ•°
          VOCAB_ROUNDS: "3"    # ãƒ©ã‚¦ãƒ³ãƒ‰æ•°
          WORD_REPEAT:  "1"    # å˜èªèª­ã¿ä¸Šã’ã®ç¹°ã‚Šè¿”ã—å›æ•°
          CONTENT_MODE: "vocab"
          TARGET_ACCOUNT: "acc9"  # â† å‡ºåŠ›ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
          DEBUG_SCRIPT: "1"
        run: |
          python main.py "AUTO" --privacy public --chunk 999

  # â‘¡ å˜èªï¼‹ä¾‹æ–‡ï¼‹æœ€å¾Œã«ä¼šè©±1ãƒ–ãƒ­ãƒƒã‚¯ â€” NO_CONVO=0, FINAL_CONVO=1
  vocab_final_convo:
    name: â‘¡ Vocab + Final Convoï¼ˆæœ€å¾Œã«ä¼šè©±1ãƒ–ãƒ­ãƒƒã‚¯ï¼‰
    runs-on: ubuntu-latest
    needs: _setup
    if: >
      (github.event_name == 'schedule' && github.event.schedule == '0 6 * * *')
      || (github.event_name == 'workflow_dispatch' && inputs.mode == 'final-convo')
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ¬ Generate & Upload
        env:
          OPENAI_API_KEY:      ${{ secrets.OPENAI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          # â”€ å‹•ç”»ã®ä¸­èº«ã‚’æ±ºã‚ã‚‹ãƒ•ãƒ©ã‚° â”€
          NO_CONVO:     "0"    # ä¼šè©±ã‚’å‡ºã™
          FINAL_CONVO:  "1"    # æœ€å¾Œã«1å›ã ã‘ä¼šè©±ãƒ–ãƒ­ãƒƒã‚¯
          CONVO_LINES:  "12"   # ä¼šè©±ã®è¡Œæ•°ï¼ˆå¶æ•°æ¨å¥¨ï¼‰
          VOCAB_WORDS:  "10"
          VOCAB_ROUNDS: "2"
          WORD_REPEAT:  "1"
          CONTENT_MODE: "vocab"
          TARGET_ACCOUNT: "acc9"
          DEBUG_SCRIPT: "1"
        run: |
          python main.py "AUTO" --privacy public --chunk 999

  # â‘¢ å˜èªï¼‹ä¾‹æ–‡ï¼‹å„ãƒ©ã‚¦ãƒ³ãƒ‰ã”ã¨ã«ä¼šè©± â€” NO_CONVO=0, FINAL_CONVO=0
  vocab_every_convo:
    name: â‘¢ Vocab + Every Convoï¼ˆå„ãƒ©ã‚¦ãƒ³ãƒ‰æœ«ã«ä¼šè©±ï¼‰
    runs-on: ubuntu-latest
    needs: _setup
    if: >
      (github.event_name == 'schedule' && github.event.schedule == '0 12 * * *')
      || (github.event_name == 'workflow_dispatch' && inputs.mode == 'every-convo')
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ¬ Generate & Upload
        env:
          OPENAI_API_KEY:      ${{ secrets.OPENAI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          # â”€ å‹•ç”»ã®ä¸­èº«ã‚’æ±ºã‚ã‚‹ãƒ•ãƒ©ã‚° â”€
          NO_CONVO:     "0"    # ä¼šè©±ã‚’å‡ºã™
          FINAL_CONVO:  "0"    # ãƒ©ã‚¦ãƒ³ãƒ‰ã”ã¨ã«ä¼šè©±
          CONVO_LINES:  "10"
          VOCAB_WORDS:  "8"
          VOCAB_ROUNDS: "3"
          WORD_REPEAT:  "1"
          CONTENT_MODE: "vocab"
          TARGET_ACCOUNT: "acc9"
          DEBUG_SCRIPT: "1"
        run: |
          python main.py "AUTO" --privacy public --chunk 999

  # å¤±æ•—æ™‚ã§ã‚‚ãƒ‡ãƒãƒƒã‚°å›å
  upload_debug:
    name: â¤´ï¸ Upload debug artifacts
    if: always()
    runs-on: ubuntu-latest
    needs: [vocab_no_convo, vocab_final_convo, vocab_every_convo]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/upload-artifact@v4
        with:
          name: debug-temp
          path: |
            temp/script_raw.txt
            temp/script_tts.txt
            temp/subs_table.tsv
            temp/durations.txt
            temp/script_joined.tsv
            temp/spec.json
          if-no-files-found: ignore